@inherits Nancy.ViewEngines.Razor.NancyRazorViewBase<dynamic>
@using CloudPanel;

@{
    Layout = "__master.cshtml";
}

@section HEAD{
    <link href="~/Content/plugins/datatables-1.10.2/media/css/jquery.dataTables.bootstrap.css" rel="stylesheet" />
    <link href="~/Content/plugins/form-parsley-new/parsley.css" rel="stylesheet" />
    <style type="text/css">
        span.tab-space {
            padding-left: 0.5em;
        }
        td.details-control {
	        background: url('@Url.Content("~/Content/img/details_open.png")') no-repeat center center;
	        cursor: pointer;
        }
        tr.shown td.details-control {
	        background: url('@Url.Content("~/Content/img/details_close.png")') no-repeat center center;
        }
    </style>
}

<div id="page-heading">
    <ol class="breadcrumb">
        <li><a href="~/dashboard">Dashboard</a></li>
        <li><a href="~/company/@this.RenderContext.Context.GetCompanyCode()/overview">@this.RenderContext.Context.GetCompanyName()</a></li>
        <li><a href="~/company/@this.RenderContext.Context.GetCompanyCode()/users">Users</a></li>
        <li class="active">Import</li>
    </ol>

    <h1>Import</h1>
</div>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-primary">
                <div class="panel-heading">Import Users</div>
                <div class="panel-body collapse in">
                    <div class="row">
                        <div class="fileinput fileinput-new" style="float:right" data-provides="fileinput">
                            <span class="btn btn-default btn-file"><span class="fileinput-new">Select file</span><span class="fileinput-exists">Change</span><input type="file" id="files" name="..."></span>
                            <span class="fileinput-filename"></span>
                            <a href="#" class="close fileinput-exists" data-dismiss="fileinput" style="float: none">&times;</a>
                        </div>
                    </div>

                    <div class="row">
                    <table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered datatables" id="dataTable">
                       <thead>
                           <tr>
                               <th width="24px" align="center"></th>
                               <th>Identity</th>
                               <th>Message</th>
                           </tr>
                       </thead>
                        <tbody>
                        </tbody>
                    </table>
                    </div>
                </div>
                <div class="panel-footer">
                    <button id="submit" name="submit" class="btn-primary btn" type="submit">Submit</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="blockMessage" style="display: none">Please Wait...</div>

@section JAVASCRIPT{
   <script src="~/Content/plugins/datatables-1.10.2/media/js/jquery.dataTables.min.js"></script>
    <script src="~/Content/plugins/datatables-1.10.2/media/js/dataTables.bootstrap.js"></script>
    <script src="~/Content/plugins/papaparse/papaparse.min.js"></script>
    <script src="~/Content/plugins/form-jasnyupload/fileinput.js"></script>
    <script type="text/javascript">
    $(document).ready(function () {
        $("#dataTable").DataTable();

        var config = buildConfig();
        $("#submit").click(function () {
            if (!$('#files')[0].files.length) {
                ShowWarning("Please choose at least one file to parse.");
            }

            $.blockUI({ message: $("#blockMessage") });
            $('#files').parse({
                config: config,
                before: function (file, inputElem) {
                    
                },
                error: function (err, file) {
                    ShowError(err);
                },
                complete: function () {

                }
            });
        });
    });

    function buildConfig() {
        return {
            delimiter: ",",
            header: true,
            complete: completeFn,
            error: errorFn
        };
    }

    function completeFn(results) {
        if (results && results.errors) {
            if (results.errors) {
                errorCount = results.errors.length;
                firstError = results.errors[0];
            }
            if (results.data && results.data.length > 0)
                rowCount = results.data.length;
        }

        $.each(results.data, function (index, value) {
            Import(value);
        });

        $.unblockUI();
    }

    function errorFn(err, file) {
        console.log("ERROR:", err, file);
    }

    function Import(user) {
        $("#blockMessage").html('Importing ' + user.UserPrincipalName);

        var t = $("#dataTable").DataTable();
        $.ajax({
            type: "POST",
            url: "",
            data: user,
            async: false,
            cache: false,
          }).success(function () {
              t.row.add(["<img src='@Url.Content("~/Content/img/success.png")' width='24px' />", user.UserPrincipalName, "Successfully created user"]).draw();
          }).fail(function (data) {
              var r = t.row.add(["<img src='@Url.Content("~/Content/img/error.png")' width='24px' />", user.UserPrincipalName, "Error: " + data.responseJSON.error]).draw().node();
              $(r).css('color', 'red');
          });
    }
    </script>
}